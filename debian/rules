#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

include /usr/share/cdbs/1/rules/buildvars.mk
CMAKE ?= cmake

INSTALL_PREFIX ?= /usr
OP2=${CURDIR}/op2
OP2_C_HOME=${OP2}/c
OP2_C_BUILD=${OP2_C_HOME}/build
OP2_FORTRAN_HOME=${OP2}/fortran
DEB_DESTDIR ?= $(CURDIR)/debian/tmp/
DEB_MAKE_INSTALL_TARGET ?= install DESTDIR=$(DEB_DESTDIR)
CMAKE_FLAGS = -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" -DCMAKE_SKIP_RPATH=ON

%:
	dh $@

override_dh_auto_build: ${OP2_C_BUILD}/CMakeCache.txt
	dh_testdir
	cd ${OP2_C_BUILD} && make
	#OP2=${OP2} OP2_COMPILER="gnu" make -C ${OP2_FORTRAN_HOME}

override_dh_install:
	dh_testdir
	cd ${OP2_C_BUILD} && make ${DEB_MAKE_INSTALL_TARGET}
	dh_install

override_dh_auto_configure:
	dh_testdir
	mkdir -p ${OP2_C_BUILD} && cd ${OP2_C_BUILD} && cmake ${CMAKE_FLAGS} ${OP2_C_HOME}

override_dh_clean:
	dh_testdir
	dh_clean
	rm -rf ${OP2_C_BUILD} ${DEB_DESTDIR}
	#make -C ${OP2_FORTRAN_HOME} clean
